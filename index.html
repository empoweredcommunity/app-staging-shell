<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Empowered Community — Staging App Shell</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b1220; color:#f2f4f8; }
    header { padding:24px; border-bottom:1px solid #22304d; }
    main { max-width:720px; margin: 24px auto; padding: 0 16px 80px; }
    h1 { margin:0 0 6px; font-size:20px; }
    .card { background:#121a2b; border:1px solid #22304d; border-radius:12px; padding:16px; margin:16px 0; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="email"] {
      flex:1; min-width:220px; background:#0e1627; color:#e6ebf5;
      border:1px solid #2d3c5f; border-radius:10px; padding:12px 14px; outline:none;
    }
    button {
      background:#2b6fff; color:#fff; border:0; border-radius:10px; padding:12px 16px; cursor:pointer;
    }
    button.secondary { background:#1d2a44; color:#cfe0ff; border:1px solid #2d3c5f; }
    .muted { color:#8ea3c8; font-size:13px; }
    .ok { color:#71ffa1 }
    .err { color:#ff8a8a }
    pre {
      white-space:pre-wrap; overflow-wrap:anywhere; background:#0e1627; border:1px dashed #2d3c5f;
      padding:10px; border-radius:8px; max-height:280px; overflow:auto;
    }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Empowered Community — <span class="muted">Staging App Shell</span></h1>
    <div class="muted">Calls the staging API at <code>https://api-staging.empowered.community</code></div>
  </header>

  <main>
    <!-- Section: Manual Sign-in link request -->
    <section class="card" id="request-card">
      <h2>Send yourself a sign-in link (staging)</h2>
      <div class="row">
        <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
        <button id="sendBtn">Send link</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        We’ll email a one-time magic link. In staging, the API also returns the magic link (for testing).
      </div>
      <div id="requestStatus" class="muted" style="margin-top:10px;"></div>
      <div id="devArea" class="hidden" style="margin-top:10px;">
        <button id="followMagic" class="secondary">Follow magic link (dev)</button>
      </div>
    </section>

    <!-- Section: Magic handler -->
    <section class="card" id="magic-card">
      <h2>Magic Link Handler</h2>
      <div id="magicStatus" class="muted">If you opened a link like <code>/magic?token=…</code>, we’ll finish sign-in here.</div>
    </section>

    <!-- Section: Debug log -->
    <section class="card">
      <h2>Debug Log</h2>
      <pre id="log">Ready.</pre>
    </section>
  </main>

  <script>
    // ===== CONFIG =====
    const API_BASE = 'https://api-staging.empowered.community'; // Render reverse proxy to CF Worker
    const CONSENT_VERSION = '1.2.2';

    // ===== DOM =====
    const el = (id) => document.getElementById(id);
    const emailInput = el('email');
    const sendBtn = el('sendBtn');
    const requestStatus = el('requestStatus');
    const magicStatus = el('magicStatus');
    const logBox = el('log');
    const devArea = el('devArea');
    const followMagicBtn = el('followMagic');

    // ===== Helpers =====
    function log(msg, kind='info') {
      const stamp = new Date().toISOString().replace('T',' ').slice(0,19);
      const prefix = kind === 'error' ? '❌' : kind === 'ok' ? '✅' : '•';
      logBox.textContent += `\n${prefix} [${stamp}] ${msg}`;
      logBox.scrollTop = logBox.scrollHeight;
    }
    function setStatus(node, html, cls='') {
      node.className = 'muted ' + (cls||'');
      node.innerHTML = html;
    }
    const sleep = (ms) => new Promise(r=>setTimeout(r, ms));

    async function getJSON(url, init) {
      const res = await fetch(url, { ...init, headers: { 'accept':'application/json', ...(init?.headers||{}) } });
      const txt = await res.text();
      let json = null; try { json = JSON.parse(txt); } catch {}
      return { ok: res.ok, status: res.status, json, txt, res };
    }

    // ===== Flow: Request sign-in link =====
    async function requestSignIn(email) {
      const url = `${API_BASE}/?op=auth.request&email=${encodeURIComponent(email)}&echo_mode=1`;
      setStatus(requestStatus, 'Requesting sign-in link…');
      log(`GET ${url}`);

      const { ok, status, json, txt } = await getJSON(url);
      if (!ok || !json?.success) {
        setStatus(requestStatus, `<span class="err">Failed</span> — status ${status}`, 'err');
        log(`auth.request failed: status=${status} body=${txt}`, 'error');
        return;
      }
      const magic = json.magic_link || '';
      setStatus(requestStatus, `<span class="ok">Link requested.</span> ${magic ? 'Magic link returned (staging).' : ''}`, 'ok');
      log(`auth.request ok: request_id=${json.request_id}`);

      if (magic) {
        devArea.classList.remove('hidden');
        followMagicBtn.onclick = () => {
          log(`Following magic link (dev): ${magic}`);
          window.location.href = magic;
        };
      }
    }

    // ===== Flow: Handle /magic?token=… =====
    async function handleMagic() {
      const usp = new URLSearchParams(location.search);
      const token = usp.get('token');

      if (!token) {
        setStatus(magicStatus, 'No token found in the URL.');
        return;
      }
      setStatus(magicStatus, 'Verifying token…');
      log(`auth.verify token=${token.slice(0,8)}…`);

      // 1) verify
      const verifyUrl = `${API_BASE}/?op=auth.verify&token=${encodeURIComponent(token)}`;
      const v = await getJSON(verifyUrl);
      if (!v.ok || !v.json?.verified) {
        setStatus(magicStatus, `<span class="err">Verify failed</span> — status ${v.status}`, 'err');
        log(`auth.verify failed: status=${v.status} body=${v.txt}`, 'error');
        return;
      }
      setStatus(magicStatus, 'Verified. Recording consent…');
      log(`auth.verify ok for ${v.json.email || '(unknown email)'}`);

      // 2) consent
      const consentBody = {
        accepted: true,
        consent_version: CONSENT_VERSION,
        email: v.json.email || ''
      };
      const c = await getJSON(`${API_BASE}/?op=consent.submit`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(consentBody)
      });
      if (!c.ok || !c.json?.stored) {
        setStatus(magicStatus, `<span class="err">Consent failed</span> — status ${c.status}`, 'err');
        log(`consent.submit failed: status=${c.status} body=${c.txt}`, 'error');
        return;
      }
      log(`consent.submit ok: receipt_id=${c.json.receipt_id}`);

      // 3) device trust (30 days)
      setStatus(magicStatus, 'Trusting device for 30 days…');
      const t = await getJSON(`${API_BASE}/?op=device.trust&trust_ttl_days=30`);
      if (!t.ok || !t.json?.expires_days || !t.json?.receipt) {
        setStatus(magicStatus, `<span class="err">Device trust failed</span> — status ${t.status}`, 'err');
        log(`device.trust failed: status=${t.status} body=${t.txt}`, 'error');
        return;
      }

      // success
      setStatus(
        magicStatus,
        `✅ Signed in successfully.<br/>Trusted for <strong>${t.json.expires_days}</strong> days. Receipt: <code>${t.json.receipt}</code>`,
        'ok'
      );
      log(`device.trust ok: expires_days=${t.json.expires_days} receipt=${t.json.receipt}`, 'ok');
    }

    // ===== Wire up UI =====
    sendBtn.addEventListener('click', async () => {
      const email = (emailInput.value || '').trim();
      if (!email) {
        setStatus(requestStatus, '<span class="err">Please enter an email.</span>', 'err');
        return;
      }
      await requestSignIn(email);
    });

    // Auto-handle /magic on load
    (async () => {
      if (location.pathname.replace(/\/+$/,'') === '/magic') {
        await handleMagic();
        // Don’t auto-redirect; show the status and let the user close the tab.
      } else {
        // normal landing
      }
    })();
  </script>
</body>
</html>
